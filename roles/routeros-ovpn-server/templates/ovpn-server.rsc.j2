/log warning "Ansible is configuring OpenVPN Server now..."

/interface list
:if ([/interface list find name={{ profile }}] ="") do={
    /interface list add name={{ profile }};
    :put "Interface List Added"} else={
    :put "Interface List already exists"
}

/ppp profile
:if ([/ppp profile find name={{ profile }}] ="") do={
    /ppp profile add name={{ profile }} local-address={{ vpn_subnet | ipaddr('net') | ipaddr('-1') | ipaddr('address') }} address-list={{ profile }} interface-list={{ profile }} use-encryption=required;
    :put "PPP Profile Added"} else={
    :put "PPP Profile already exists"
}
### NEED to add certificates
/interface ovpn-server server set enabled=yes default-profile={{ profile }} mode=ip require-client-certificate=yes auth=sha1,md5 cipher=aes256 certificate={{ profile }}
### Need to configure

/ip firewall filter add action=accept chain=WAN-Input-Allow dst-port=1701 protocol=udp comment=L2TP
/ip firewall filter add action=accept chain=WAN-Input-Allow dst-port=500 protocol=udp comment=IPSec
/ip firewall filter add action=accept chain=WAN-Input-Allow dst-port=4500 protocol=udp comment=IPSec

# OSPF
/routing ospf instance set 0 router-id={{ vpn_subnet | ipaddr('network') }}

/routing ospf network
:if [/routing ospf network find network={{ vpn_subnet }}] do={/routing ospf network set [find network={{ vpn_subnet }}] area=backbone} else={/routing ospf network add area=backbone network={{ vpn_subnet }}}